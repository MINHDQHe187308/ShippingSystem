@using ReflectionIT.Mvc.Paging
@using ODCS.BaseCommon;
@using Microsoft.AspNetCore.Authorization
@using ODCS.Controllers.Admin
@using ODCS.Policies
@inject IAuthorizationService AuthorizationService
@addTagHelper *, ReflectionIT.Mvc.Paging
@model ODCS.Models.Front.Reports.ReportFactoryModel
@{
    ViewData["Title"] = "RPT LINH KIỆN";
    Layout = "../Shared/Layout/Front/_Layout";
    var fYear = "";//DateTime.Now.Year.ToString();
    if (ViewContext.RouteData.Values["fYear"] != null)
    {
        fYear = ViewContext.RouteData.Values["fYear"].ToString();
    }
    var fCat = "";
    if (ViewContext.RouteData.Values["fCat"] != null)
    {
        fCat = ViewContext.RouteData.Values["fCat"].ToString();
    }
}
<style>
    #chart-factory {
        width: 100%;
        position: relative;
    }

    .search-form {
        border: 1px solid #ccc;
        padding: 15px 10px;
        position: relative;
    }

    legend {
        position: absolute;
        top: -21px;
        left: 28px;
        background: #fff;
        display: inline-block;
        max-width: 80px;
        padding: 0px 10px;
    }

    .sect-right, .sect-left {
        border: 1px solid #ccc;
        border-radius: 15px;
        /*min-height: 600px;*/
        padding: 15px;
        overflow: scroll;
    }

    .sect-right {
        /*min-height: 625px;*/
    }

    #table-factory {
        max-width: 100%;
        overflow: scroll;
        margin: 0px !important;
    }

        #table-factory table {
            margin: 0px !important;
        }

        #table-factory th.active, #table-factory th:hover {
            background-color: rgb(75, 192, 192);
            cursor: pointer;
        }

    #chart-judge {
        position: absolute;
        top: 0px;
        right: 0px;
        display: inline-block;
        z-index: 9999;
        font-size: 1.7em;
        border: 1px solid #ccc;
        padding: 0 15px;
        font-weight: bold;
    }
</style>

<div class="container-fluid bd-example">
    <div class="row">
        <div class="col-lg-12 col-md-12 col-xs-12">
            <h2 style="margin-bottom: 15px;">INVENTORY OF <span>@ViewBag.CatName</span></h2>
            <form method="get" class="search-form">
                <fieldset>
                    <legend>Filter:</legend>
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label for="fYear" class="form-label">Year</label>
                                <select asp-items="@ViewBag.sltYears" asp-for="@fYear" id="fYear" name="fYear" class="form-control" required>
                                    <option value="">-- Choose --</option>
                                </select>
                            </div>
                        </div><!-- /col -->
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label for="fCat" class="form-label">Category</label>
                                <select asp-items="@ViewBag.sltTypeProduct" asp-for="@fCat" id="fCat" name="fCat" class="form-control" required>
                                    <option value="">-- Choose --</option>
                                </select>
                            </div>
                        </div><!-- /col -->
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label for="fYear" class="form-label" style="color: #fff;">.</label>
                                <div class="text-start">
                                    <div class="form-group">
                                        <button type="submit" class="btn btn-info">
                                            <i class="fas fa-search"></i> Search
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div><!-- /col -->
                    </div>
                </fieldset>
            </form>
            <h1 class="clearfix"></h1>
        </div>
        <!-- /.col -->
    </div>
    <div class="row justify-content-start">
        <div class="col-6 text-center sect-left">
            <div class="col-12 text-center">
                <div id="chart-factory" class="d-inline-block">
                    <div id="chart-judge">EVA: <span></span></div>
                    <div id="myChart" style="margin: 0 auto"></div>
                </div>
            </div><!-- /col 12-->
            <div class="col-12 text-start">
                <div id="table-factory" class="">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                @foreach (var item in Model.ListMonths)
                                {
                                    <th scope="col" title="Click view explain!" class="item-month" data-year="@item.Value.FirstOrDefault().Key" data-month="@item.Value.FirstOrDefault().Value">@item.Key</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.ListValues)
                            {
                                <tr class="@item.Key">
                                    <td scope="col"><strong>@item.Key</strong></td>
                                    @foreach (var item2 in item.Value)
                                    {
                                        <td scope="col"><span>@item2</span></td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                    <table id="table-judge" class="table d-none">
                        <tbody>
                            <tr>
                                @if (Model.Evaluations != null)
                                {
                                    foreach (var item in Model.Evaluations)
                                    {
                                        string inputID = $"{item.Month}-{item.Year}";
                                        <td>
                                            <p>@item.Month <span>-</span>@item.Year</p>
                                            <p><span>Đánh giá: </span>@item.Judge</p>
                                            <p><input id="@inputID" value="@item.Judge" /></p>
                                        </td>
                                    }
                                }
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div><!-- /col 12 -->
        </div><!-- /col6 -->
        <div class="col-6">
            <div class="sect-right section-explain">
                <div class="text-start section-explain-evaluation">
                </div>
                <h3 class="text-start section-explain-title"></h3>
                <div class="section-explain-content">
                </div>
            </div><!-- .section-explain -->
        </div>


    </div>
</div>
@section Scripts {
<script>
    let xAxisCategories = @Html.Raw(ViewBag.xAxisCategories);
    let series = @Html.Raw(ViewBag.series);
    let seriesData = series.Series;
    let catName = "@ViewBag.CatName";

    Highcharts.chart('myChart', {
          title: {
              text: 'INVENTORY OF ' + catName
          },
          legend: {
            enabled: true
          },
          xAxis: [{
                categories: @Html.Raw(ViewBag.xAxisCategories)
            }],
          yAxis: {
            stackLabels: {
              enabled: true,
              style: {
                color: 'black'
              }
            }
          },
          plotOptions: {
            column: {
              stacking: 'normal'
            },
            line: {
              dataLabels: {
                allowOverlap: true,
                enabled: false
              }
            }
          },
          series: seriesData
        });


</script>
<script>
    $(document).ready(function(){
        let hLeft = $('.sect-left').height();
        let hRight = $('.section-explain').height();
        if(hLeft <= hRight){
            $('.sect-left').height(hRight);
        }else{
            $('.section-explain').height(hLeft);
        }
        $('.item-month').click(function (e) {
        $( ".item-month" ).removeClass( "active" )
            $(this).addClass("active");
            let year = $( this ).attr( "data-year" );
            if (year == "" || year == null) {
                alert("The Year field is required.");
                return false;
            }
            let month = $( this ).attr( "data-month" );
            let cat = $('#fCat').val();
        //
            $.ajax({
                    type: 'GET',
                    url: '/Report/GetCategoryExplain',
                    data: {
                        year:year,
                        month:month,
                        cat:cat
                    },
                    contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                    processData: true,
                    beforeSend: function () {
                        $('#sct-loading').show();
                        $(this).removeAttr('disabled');
                    },
                    success: function (data) {
                        $(this).removeAttr('disabled');
                        $('#sct-loading').hide();
                        let strLink = "<a href='/admin/StatisticalCat/Edit/"+data.id+"'>Explaination</a>";
                        $('.section-explain-title').html(strLink);
                        $('.section-explain-content').html(data.data);
                        //
                        let hLeft = $('.sect-left').height();
                        let hRight = $('.section-explain').height();
                        if(hLeft <= hRight){
                            $('.sect-left').height(hRight);
                        }else{
                            $('.section-explain').height(hLeft);
                        }
                        // judge
                        let judge = $('#'+month+'-'+year).val();
                        if(judge == 'O'){
                            $("#chart-judge span").css("color","blue");
                        }else{
                            $("#chart-judge span").css("color","red");
                        }
                        $("#chart-judge span").html(judge);
                    },
                    error: function () {
                        $(this).removeAttr('disabled');
                        $('#sct-loading').hide();
                        alert("error");
                    }
                });
            //
        });
        //
    });
</script>
}